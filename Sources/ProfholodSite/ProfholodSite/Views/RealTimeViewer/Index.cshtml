@{
    ViewBag.Title = "Index";
}

<div id="OnLineButton"></div>
<br />

<h4>
    <table style="width:50%">
        <tr><td><em><font color="blue">Скорость пресса:</font></em></td> <td>- - -</td></tr>
        <tr><td><em><font color="blue">Начало заливки:</font></em></td> <td><div id="casting_begin"><span></span></div></td></tr>
        <tr><td><em><font color="blue">Последние данные:</font></em></td> <td><div id="data_last"><span></span></div></td></tr>
    </table>
</h4>

    <table style="width:100%">
        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MA_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MA_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MA_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MA_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_A' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MB_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MB_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MB_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MB_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_B' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MC_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MC_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MC_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MC_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_C' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MD_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MD_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MD_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MD_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_D' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="ME_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="ME_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="ME_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="ME_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_E' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>


        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MF_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MF_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MF_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MF_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_F' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MN_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MN_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MN_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MN_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_N' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MNuc_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MNuc_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MNuc_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MNuc_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_Nuc' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

    </table>

    <script type="text/javascript">

        function TransalteTime(value) {
            var datestamp = new Date(value.getUTCFullYear(), value.getUTCMonth(), value.getDate(), value.getUTCHours(), value.getMinutes(), value.getUTCSeconds());
            return datestamp;
        }

        // prepare chart data as an array
        function CreateSource(postifx) {
            var source =
                {
                    dataType: "json",
                    async: false,
                    dataFields: [
                        { name: 'D', type: 'date' },
                        { name: 'S', type: 'float' },
                        { name: 'R', type: 'float' },
                        { name: 'E', type: 'float' },
                        { name: 'P', type: 'float' }
                    ],
                    id: 'Id',
                    url: 'GetDataJson' + "?Material=" + postifx
                };
            return source;
        }

        var dataAdapters = new Map();

        // prepare jqxChart settings
        function CreateSetting(Title, Description, CodeSymbol) {

            var dataAdapter = new $.jqx.dataAdapter(CreateSource(CodeSymbol));
            dataAdapters.set(CodeSymbol,dataAdapter);

            var settings = {

                title: Title,

                description: Description,

                enableAnimations: false,

                enableCrosshairs: false,

                showLegend: true,

                padding: { left: 5, top: 5, right: 40, bottom: 5 },

                titlePadding: { left: 90, top: 0, right: 0, bottom: 10 },

                source: dataAdapter,

                xAxis:

                {

                    dataField: 'D',
                    type: 'date',
                    baseUnit: 'second',
                    flip: false,
                    gridLines: { visible: true },
                    showToolTips: false,

                    formatFunction: function (value) {
                       return $.jqx.dataFormat.formatdate(TransalteTime(value), "HH:mm:ss", 'en-us');

                    }

                },

                colorScheme: 'scheme02',

                seriesGroups:

                    [

                          {
                              type: 'line',
                              series: [{ dataField: 'P', displayText: 'Ошибка (%)', opacity: 0.7, lineWidth: 1 }]

                          },
                        {

                            type: 'line',

                            series: [
                                  { dataField: 'R', displayText: 'Фактическое', opacity: 0.7, lineWidth: 1 },
                                  { dataField: 'S' + CodeSymbol, displayText: 'Установленное', opacity: 1, lineWidth: 2 },
                            ]

                        }
                    ]

            };

            return settings;
        }


        // setup the chart
        $('#OnLineButton').jqxSwitchButton({ height: 'auto', width: 'auto', checked: true, onLabel: 'Онлайн', offLabel: 'Оффлайн' });

        $('#jqxChart_A').jqxChart(CreateSetting("Maтериал A", "", "A"));
        $('#jqxChart_B').jqxChart(CreateSetting("Maтериал B", "", "B"));
        $('#jqxChart_C').jqxChart(CreateSetting("Maтериал C", "", "C"));
        $('#jqxChart_D').jqxChart(CreateSetting("Maтериал D", "", "D"));
        $('#jqxChart_E').jqxChart(CreateSetting("Maтериал E", "", "E"));
        $('#jqxChart_F').jqxChart(CreateSetting("Maтериал F", "", "F"));
        $('#jqxChart_N').jqxChart(CreateSetting("Maтериал N", "", "N"));
        $('#jqxChart_Nuc').jqxChart(CreateSetting("Maтериал Nuc", "", "Nuc"));

       
        function Update()
        {
            function Reset(l)
            {
                $("#M"+l+"_Real").find('span').remove();
                $("#M"+l+"_Set").find('span').remove();
                $("#M" + l + "_ErrAbs").find('span').remove();
                $("#M" + l + "_ErrPrc").find('span').remove();
            }

            function Set(l, r, s, e, p)
            { 

                $("#M" + l + "_Real").append("<span>" + r + "</span>");
                $("#M" + l + "_Set").append("<span>" + s + "</span>");
                $("#M" + l + "_ErrAbs").append("<span>" + e + "</span>");
                $("#M" + l + "_ErrPrc").append("<span>" + p + "</span>");

            }

            var casting_begin = "";
            var data_last = "";


            dataAdapters.forEach(function (item, key, mapObj) {
                Reset(key);
                if (item != null)
                    if (item.getrecords().length > 0)
                    {
                        var last = item.getrecords()[item.getrecords().length - 1];
                        Set(key, last.R, last.S, last.E,last.P);
                    }
               
            });

            //if (dataAdapter.getrecords().length > 0)
            {
                //var last = dataAdapter.getrecords()[dataAdapter.getrecords().length - 1];
                //var CastingSession = "";
               // var RecordTime = last.D;
           
                //casting_begin = $.jqx.dataFormat.formatdate(TransalteTime(CastingSession), "dd-MM-yyyy HH:mm:ss", 'en-us');
                //data_last = $.jqx.dataFormat.formatdate(TransalteTime(RecordTime), "dd-MM-yyyy HH:mm:ss", 'en-us');
                
                /*
                $("#MA_Real").append("<span>" + last.realMeterialA.toFixed(4) + "</span>");
                $("#MA_Set").append("<span>" + last.setMeterialA.toFixed(4) + "</span>");
                $("#MA_ErrAbs").append("<span>" + last.errorMeterialA.toFixed(4) + "</span>");
                $("#MA_ErrPrc").append("<span>" + last.errorMeterialA_Percent.toFixed(4) + "</span>");

                $("#MB_Real").append("<span>" + last.realMeterialB.toFixed(4) + "</span>");
                $("#MB_Set").append("<span>" + last.setMeterialB.toFixed(4) + "</span>");
                $("#MB_ErrAbs").append("<span>" + last.errorMeterialB.toFixed(4) + "</span>");
                $("#MB_ErrPrc").append("<span>" + last.errorMeterialB_Percent.toFixed(4) + "</span>");

                $("#MC_Real").append("<span>" + last.realMeterialC.toFixed(4) + "</span>");
                $("#MC_Set").append("<span>" + last.setMeterialC.toFixed(4) + "</span>");
                $("#MC_ErrAbs").append("<span>" + last.errorMeterialC.toFixed(4) + "</span>");
                $("#MC_ErrPrc").append("<span>" + last.errorMeterialC_Percent.toFixed(4) + "</span>");

                $("#MD_Real").append("<span>" + last.realMeterialD.toFixed(4) + "</span>");
                $("#MD_Set").append("<span>" + last.setMeterialD.toFixed(4) + "</span>");
                $("#MD_ErrAbs").append("<span>" + last.errorMeterialD.toFixed(4) + "</span>");
                $("#MD_ErrPrc").append("<span>" + last.errorMeterialD_Percent.toFixed(4) + "</span>");

                $("#ME_Real").append("<span>" + last.realMeterialE.toFixed(4) + "</span>");
                $("#ME_Set").append("<span>" + last.setMeterialE.toFixed(4) + "</span>");
                $("#ME_ErrAbs").append("<span>" + last.errorMeterialE.toFixed(4) + "</span>");
                $("#ME_ErrPrc").append("<span>" + last.errorMeterialE_Percent.toFixed(4) + "</span>");

                $("#MF_Real").append("<span>" + last.realMeterialF.toFixed(4) + "</span>");
                $("#MF_Set").append("<span>" + last.setMeterialF.toFixed(4) + "</span>");
                $("#MF_ErrAbs").append("<span>" + last.errorMeterialF.toFixed(4) + "</span>");
                $("#MF_ErrPrc").append("<span>" + last.errorMeterialF_Percent.toFixed(4) + "</span>");

                $("#MN_Real").append("<span>" + last.realMeterialN.toFixed(4) + "</span>");
                $("#MN_Set").append("<span>" + last.setMeterialN.toFixed(4) + "</span>");
                $("#MN_ErrAbs").append("<span>" + last.errorMeterialN.toFixed(4) + "</span>");
                $("#MN_ErrPrc").append("<span>" + last.errorMeterialN_Percent.toFixed(4) + "</span>");

                $("#MNuc_Real").append("<span>" + last.realMeterialNuc.toFixed(4) + "</span>");
                $("#MNuc_Set").append("<span>" + last.setMeterialNuc.toFixed(4) + "</span>");
                $("#MNuc_ErrAbs").append("<span>" + last.errorMeterialNuc.toFixed(4) + "</span>");
                $("#MNuc_ErrPrc").append("<span>" + last.errorMeterialNuc_Percent.toFixed(4) + "</span>");
                */

            }
            $("#casting_begin").find('span').remove();
            $("#casting_begin").append("<span>"+casting_begin+"</span>");
            $("#data_last").find('span').remove();
            $("#data_last").append("<span>" + data_last + "</span>");

            
           
        }
        Update();

        //var ttimer = setInterval(function () {
        //    dataAdapter.dataBind();
        //    Update();
        //}, 5000);

    </script>




