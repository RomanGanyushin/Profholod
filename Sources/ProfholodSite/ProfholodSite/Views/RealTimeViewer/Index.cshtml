@{
    ViewBag.Title = "Index";
}


<br />

<h4>
    <table style="width:50%">
        <tr><td><em><font color="blue">Скорость пресса:</font></em></td> <td>- - -</td></tr>
        <tr><td><em><font color="blue">Начало заливки:</font></em></td> <td><div id="casting_begin"><span></span></div></td></tr>
        <tr><td><em><font color="blue">Последние данные:</font></em></td> <td><div id="data_last"><span></span></div></td></tr>
    </table>
</h4>
<div id="OnLineButton"></div>

    <table style="width:100%">
        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MA_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MA_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MA_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MA_ErrPrc"><span></span></div></td></tr>          
                 </table>

               
            </td>
            <td>
                <div id='jqxChart_A' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MB_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MB_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MB_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MB_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_B' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MC_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MC_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MC_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MC_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_C' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MD_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MD_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MD_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MD_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_D' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="ME_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="ME_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="ME_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="ME_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_E' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>


        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MF_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MF_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MF_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MF_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_F' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MN_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MN_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MN_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MN_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_N' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MNuc_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MNuc_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MNuc_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MNuc_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_Nuc' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

    </table>

    <script type="text/javascript">

     
        // prepare chart data as an array
        function CreateSource(postifx, lastDate) {
            var source =
                {
                    dataType: "json",
                    async: true,
                    dataFields: [
                        { name: 'D', type: 'string' },
                        { name: 'S', type: 'float' },
                        { name: 'R', type: 'float' },
                        { name: 'E', type: 'float' },
                        { name: 'P', type: 'float' }
                    ],
                    id: 'Id',
                    url: 'GetDataJson' + "?Material=" + postifx + "&LastDate=" + lastDate
                };
            return source;
        }

       
        var dataLocalAdapters = new Map();

        // prepare jqxChart settings
        function CreateSetting(Title, Description, CodeSymbol) {

            dataLocalAdapters.set(CodeSymbol, []);

            var settings = {

                title: Title,

                description: Description,

                enableAnimations: false,

                enableCrosshairs: false,

                showLegend: true,

                padding: { left: 5, top: 5, right: 40, bottom: 5 },

                titlePadding: { left: 90, top: 0, right: 0, bottom: 10 },

                source: dataLocalAdapters.get(CodeSymbol),

                xAxis:

                {

                    dataField: 'D',
                    type: 'date',
                    baseUnit: 'second',
                    flip: false,
                    gridLines: { visible: true },
                    showToolTips: false,

                    formatFunction: function (value) {
                       return $.jqx.dataFormat.formatdate(value, "HH:mm:ss", 'en-us');

                    }

                },

                colorScheme: 'scheme02',

                seriesGroups:

                    [

                          {
                              type: 'line',
                              series: [{ dataField: 'P', displayText: 'Ошибка (%)', opacity: 0.7, lineWidth: 1 }]

                          },
                        {

                            type: 'line',

                            series: [
                                  { dataField: 'R', displayText: 'Фактическое', opacity: 0.7, lineWidth: 1 },
                                  { dataField: 'S' + CodeSymbol, displayText: 'Установленное', opacity: 1, lineWidth: 2 },
                            ]

                        }
                    ]

            };

            return settings;
        }


        // setup the chart
        $('#OnLineButton').jqxSwitchButton({ height: '40px', width: '150px', checked: true, onLabel: 'Онлайн', offLabel: 'Оффлайн' });

        $('#jqxChart_A').jqxChart(CreateSetting("Maтериал A", "", "A"));
        $('#jqxChart_B').jqxChart(CreateSetting("Maтериал B", "", "B"));
        $('#jqxChart_C').jqxChart(CreateSetting("Maтериал C", "", "C"));
        $('#jqxChart_D').jqxChart(CreateSetting("Maтериал D", "", "D"));
        $('#jqxChart_E').jqxChart(CreateSetting("Maтериал E", "", "E"));
        $('#jqxChart_F').jqxChart(CreateSetting("Maтериал F", "", "F"));
        $('#jqxChart_N').jqxChart(CreateSetting("Maтериал N", "", "N"));
        $('#jqxChart_Nuc').jqxChart(CreateSetting("Maтериал Nuc", "", "Nuc"));

       
        function Update()
        {
            function Reset(l)
            {
                $("#M"+l+"_Real").find('span').remove();
                $("#M"+l+"_Set").find('span').remove();
                $("#M" + l + "_ErrAbs").find('span').remove();
                $("#M" + l + "_ErrPrc").find('span').remove();
            }

            function Set(l, r, s, e, p)
            { 

                $("#M" + l + "_Real").append("<span>" + r + "</span>");
                $("#M" + l + "_Set").append("<span>" + s + "</span>");
                $("#M" + l + "_ErrAbs").append("<span>" + e + "</span>");
                $("#M" + l + "_ErrPrc").append("<span>" + p + "</span>");

            }

            var casting_begin = "";
            var data_last = "";


            dataAdapters.forEach(function (item, key, mapObj) {
                Reset(key);
                if (item != null)
                    if (item.getrecords().length > 0)
                    {
                        var last = item.getrecords()[item.getrecords().length - 1];
                        Set(key, last.R, last.S, last.E,last.P);
                    }
               
            });

            //if (dataAdapter.getrecords().length > 0)
            {
                //var last = dataAdapter.getrecords()[dataAdapter.getrecords().length - 1];
                //var CastingSession = "";
               // var RecordTime = last.D;
           
                //casting_begin = $.jqx.dataFormat.formatdate(TransalteTime(CastingSession), "dd-MM-yyyy HH:mm:ss", 'en-us');
                //data_last = $.jqx.dataFormat.formatdate(TransalteTime(RecordTime), "dd-MM-yyyy HH:mm:ss", 'en-us');
            }
            $("#casting_begin").find('span').remove();
            $("#casting_begin").append("<span>"+casting_begin+"</span>");
            $("#data_last").find('span').remove();
            $("#data_last").append("<span>" + data_last + "</span>");
     
        }
        //Update();

     
        var next = new Map();

        function UpdateChart(Symbol)
        {
            next.set(Symbol,false);

            var lastDate = null;
            var start = new Date();
            if (dataLocalAdapters.get(Symbol).length > 0)
            {
                var _lastDate = dataLocalAdapters.get(Symbol)[dataLocalAdapters.get(Symbol).length - 1].D;     
                lastDate = $.jqx.dataFormat.formatdate(_lastDate, "dd-MM-yyyy HH:mm:ss", 'en-us');
           
            }

            var data = new $.jqx.dataAdapter(CreateSource(Symbol, lastDate),
             {
                 loadComplete: function (records) {

                    
                     for (var i = 0; i < data.getrecords().length; i++) {
                         var last = data.getrecords()[i];
                         var _date = new Date(Date.parse(last.D));

                         dataLocalAdapters.get(Symbol).push({ D: _date, S: last.S, R: last.R, E: last.E, P: last.P });
                     }

                     if (dataLocalAdapters.get(Symbol).length > 100) {
                         dataLocalAdapters.get(Symbol).splice(0, dataLocalAdapters.get(Symbol).length - 100);
                     }

                     $('#jqxChart_' + Symbol).jqxChart('update');

                     $('#jqxChart_' + Symbol).jqxChart('getInstance').
                         description = "L: " + lastDate +
                         ",Update count = " + data.getrecords().length +
                         ",Eclape time = " + (new Date() - start) + " ms";
                     next.set(Symbol, true);
                 }
             });
           
            
            data.dataBind();
        }

        
        var ttimer = setTimeout(function () {
            if (next.get("A") == null || next.get("A")) UpdateChart("A");
            if (next.get("B") == null || next.get("B")) UpdateChart("B");
            if (next.get("C") == null || next.get("C")) UpdateChart("C");
            if (next.get("D") == null || next.get("D")) UpdateChart("D");
            if (next.get("E") == null || next.get("E")) UpdateChart("E");
            if (next.get("F") == null || next.get("F")) UpdateChart("F");
            if (next.get("N") == null || next.get("N")) UpdateChart("N");
            if (next.get("Nuc") == null || next.get("Nuc")) UpdateChart("Nuc");
            

            //UpdateChart("A");
            //UpdateChart("B");
            //  UpdateChart("C"); UpdateChart("D");
            //  UpdateChart("E"); UpdateChart("F");
            //  UpdateChart("N"); UpdateChart("Nuc");
              setTimeout(arguments.callee, 5000);
            //Update();
        }, 5000);
      

    </script>




