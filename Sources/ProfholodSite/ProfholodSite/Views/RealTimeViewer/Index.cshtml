@{
    ViewBag.Title = "Index";
}


<br />

<h4>
    <table style="width:50%">
        <tr><td><em><font color="blue">Скорость пресса:</font></em></td> <td>- - -</td></tr>
        <tr><td><em><font color="blue">Начало заливки:</font></em></td> <td><div id="casting_begin"><span></span></div></td></tr>
        <tr><td><em><font color="blue">Последние данные:</font></em></td> <td><div id="data_last"><span></span></div></td></tr>
    </table>
</h4>
<div id="OnLineButton"></div>

    <table style="width:100%">
        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MA_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MA_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MA_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MA_ErrPrc"><span></span></div></td></tr>          
                 </table>

               
            </td>
            <td>
                <div id='jqxChart_A' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MB_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MB_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MB_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MB_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_B' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MC_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MC_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MC_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MC_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_C' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MD_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MD_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MD_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MD_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_D' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="ME_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="ME_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="ME_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="ME_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_E' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>


        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MF_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MF_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MF_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MF_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_F' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MN_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MN_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MN_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MN_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_N' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

        <tr>
            <td style="width:30%">

                <table style="width:100%">
                    <tr><td style="width:50%"><em><font color="blue">Подача:</font></em></td> <td><div id="MNuc_Real"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Уставка:</font></em></td> <td><div id="MNuc_Set"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(абс):</font></em></td> <td><div id="MNuc_ErrAbs"><span></span></div></td></tr>
                    <tr><td><em><font color="blue">Ошибка(%):</font></em></td> <td><div id="MNuc_ErrPrc"><span></span></div></td></tr>
                </table>
            </td>
            <td>
                <div id='jqxChart_Nuc' style="width: 100%; height: 400px;"></div>
            </td>
        </tr>

    </table>

    <script type="text/javascript">

     
        // prepare chart data as an array
        function CreateSource(lastDate, LastCount) {
            var source =
                {
                    dataType: "json",
                    async: true,
                    dataFields: [
                        { name: 'D'},
                        { name: 'R'},
                        { name: 'S'},
                        { name: 'E'},
                        { name: 'P'},
                        { name: 'L'}
                    ],
                
                    url: 'GetDataJson' + "?LastDate=" + lastDate + "&LastCount=" + LastCount
                };
            return source;
        }

       
        var dataLocalAdapters = new Map();

        // prepare jqxChart settings
        function CreateSetting(Title, Description, CodeSymbol) {

            dataLocalAdapters.set(CodeSymbol, []);

            var settings = {

                title: Title,

                description: Description,

                enableAnimations: false,

                enableCrosshairs: false,

                showLegend: true,

                padding: { left: 5, top: 5, right: 40, bottom: 5 },

                titlePadding: { left: 90, top: 0, right: 0, bottom: 10 },

                source: dataLocalAdapters.get(CodeSymbol),

                xAxis:

                {

                    dataField: 'D',
                    type: 'date',
                    baseUnit: 'second',
                    flip: false,
                    gridLines: { visible: true },
                    showToolTips: false,

                    formatFunction: function (value) {
                       return $.jqx.dataFormat.formatdate(value, "HH:mm:ss", 'en-us');

                    }

                },
                
               // colorScheme: 'scheme02',

                seriesGroups:

                    [

                          {
                              type: 'line',

                              valueAxis:
                                {
                                    visible: true,
                                    position: 'right'                             
                                },
                              series: [{ dataField: 'P', displayText: 'Ошибка (%)', opacity: 0.7, lineWidth: 1, lineColor: 'red', lineColorSelected: 'red', fillColor: 'red' }],                           

                          },
                        {

                            type: 'line',

                            series: [
                                  { dataField: 'R', displayText: 'Фактическое', opacity: 0.7, lineWidth: 1, lineColor: 'green', lineColorSelected: 'green', fillColor: 'green' },
                                  { dataField: 'S', displayText: 'Установленное', opacity: 1, lineWidth: 2, lineColor: 'yellow', lineColorSelected: 'yellow', fillColor: 'yellow' },
                            ]
                        }
                    ]

            };

            return settings;
        }


        // setup the chart
        $('#OnLineButton').jqxSwitchButton({ height: '40px', width: '150px', checked: true, onLabel: 'Онлайн', offLabel: 'Оффлайн' });

        $('#jqxChart_A').jqxChart(CreateSetting("Maтериал A", "", "A"));
        $('#jqxChart_B').jqxChart(CreateSetting("Maтериал B", "", "B"));
        $('#jqxChart_C').jqxChart(CreateSetting("Maтериал C", "", "C"));
        $('#jqxChart_D').jqxChart(CreateSetting("Maтериал D", "", "D"));
        $('#jqxChart_E').jqxChart(CreateSetting("Maтериал E", "", "E"));
        $('#jqxChart_F').jqxChart(CreateSetting("Maтериал F", "", "F"));
        $('#jqxChart_N').jqxChart(CreateSetting("Maтериал N", "", "N"));
        $('#jqxChart_Nuc').jqxChart(CreateSetting("Maтериал Nuc", "", "Nuc"));

      


        var lastDate = "none";

        var lock_update = false;


        function UpdateCharts()
        {
            lock_update = true;

            function Reset(l)
                   {
                       $("#M"+l+"_Real").find('span').remove();
                       $("#M"+l+"_Set").find('span').remove();
                       $("#M" + l + "_ErrAbs").find('span').remove();
                       $("#M" + l + "_ErrPrc").find('span').remove();
                    }

                    function Set(l, r, s, e, p)
                    { 

                        $("#M" + l + "_Real").append("<span>" + r + "</span>");
                        $("#M" + l + "_Set").append("<span>" + s + "</span>");
                        $("#M" + l + "_ErrAbs").append("<span>" + e + "</span>");
                        $("#M" + l + "_ErrPrc").append("<span>" + p + "</span>");
                    }

            var start = new Date();
 
            var data = new $.jqx.dataAdapter(CreateSource( lastDate,100),
             {
                 loadComplete: function (records) {

                     var _lastDate;
                     for (var i = 0; i < data.getrecords().length; i++) {
                         var last = data.getrecords()[i];
                         var _date = new Date(Date.parse(last.D));

                         if (_lastDate == null) _lastDate = _date;
                         else if (_lastDate < _date) _lastDate = _date;

                         dataLocalAdapters.get(last.L).push({ D: _date, S: last.S, R: last.R, E: last.E, P: last.P });
                     }

                     if (_lastDate!=null) {                        
                         lastDate = $.jqx.dataFormat.formatdate(_lastDate, "dd-MM-yyyy HH:mm:ss", 'en-us');
                     }

                     dataLocalAdapters.forEach(function (item, key, mapObj) {

                         if (dataLocalAdapters.get(key).length > 100) {
                             dataLocalAdapters.get(key).splice(0, dataLocalAdapters.get(key).length - 100);
                         }

                         $('#jqxChart_' + key).jqxChart('update');

                         $('#jqxChart_' + key).jqxChart('getInstance').
                             description = "L: " + lastDate +
                             ",Update count = " + data.getrecords().length +
                             ",Eclape time = " + (new Date() - start) + " ms";

                         Reset(key);
                         if (dataLocalAdapters.get(key).length > 0)
                         {
                             var _lastvalue = dataLocalAdapters.get(key)[dataLocalAdapters.get(key).length-1];
                             Set(key, _lastvalue.R, _lastvalue.S, _lastvalue.E,_lastvalue.P);
                         }

                        

                     });
                    lock_update = false;
                 }
                
             });
                     
            data.dataBind();
        } UpdateCharts();

        
        var ttimer = setTimeout(function () {
            if (lock_update) UpdateCharts();
            setTimeout(arguments.callee, 5000);
           }, 5000);
      

    </script>




